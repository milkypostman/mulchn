// Generated by CoffeeScript 1.4.0
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['jquery', 'lodash', 'backbone', 'location', 'logindialog', 'question/collection', 'question/model'], function($, _, Backbone, Location, LoginDialog, QuestionCollection, QuestionModel) {
    var QuestionItem, QuestionList;
    QuestionItem = (function(_super) {

      __extends(QuestionItem, _super);

      function QuestionItem() {
        this.render = __bind(this.render, this);

        this.expand = __bind(this.expand, this);

        this.collapse = __bind(this.collapse, this);

        this.vote = __bind(this.vote, this);

        this.initialize = __bind(this.initialize, this);
        return QuestionItem.__super__.constructor.apply(this, arguments);
      }

      QuestionItem.prototype.questionTmpl = _.template('\
      <div class="question-header">\
        <span class="question-text"><%= question.get("question") %></span>\
          <% if (question.get("vote")) { %>\
          <div class="vote-count pull-right"><%= question.votes() %></div>\
          <div class="vote-count-prefix pull-right">results:</div>\
          <% } else { %>\
          <div class="vote-info pull-right">no choice selected</div>\
          <% } %>\
      </div>\
      <ul class="answers slicklist" <% if (active) { %>style="display: block;"<% } %> >\
      <% for (_i=0, _answers=question.get("answers"), _len=_answers.length; _i < _len; _i++) { answer = _answers[_i];  %>\
        <li class="answer <% if (answer._id == question.get("vote")) { %>vote<% } %>" id="<%= answer._id %>">\
          <i class="icon-ok"></i> <%= answer.answer %>\
          <% if (question.get("vote")) { %>\
          <div class="vote-count pull-right"><%= answer.votes | 0 %></div>\
          <div class="vote-count-prefix pull-right">.</div>\
          <div class="vote-percent pull-right"><%= answer.votes / question.votes() * 100 %>%</div>\
          <% } %>\
        </li>\
      <% } %>\
      </ul>');

      QuestionItem.prototype.tagName = "li";

      QuestionItem.prototype.events = {
        "click .answer": "vote"
      };

      QuestionItem.prototype.active = false;

      QuestionItem.prototype.initialize = function() {
        return this.model.on("change", this.render);
      };

      QuestionItem.prototype.vote = function(event) {
        var answer;
        answer = event.currentTarget.id;
        this.model.save({
          vote: answer,
          position: Location.position
        }, {
          wait: true,
          url: "/v1/question/vote/",
          error: function(model, response) {
            model.unset("vote");
            $("#" + answer).removeClass("working");
            return new LoginDialog().render();
          }
        });
        $("#" + answer).addClass("working");
        return false;
      };

      QuestionItem.prototype.attributes = function() {
        var c, classes;
        classes = ["question"];
        if (this.active) {
          classes.push("active");
        }
        return {
          id: this.model.id,
          "class": ((function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = classes.length; _i < _len; _i++) {
              c = classes[_i];
              _results.push(c);
            }
            return _results;
          })()).join(" ")
        };
      };

      QuestionItem.prototype.collapse = function() {
        this.active = false;
        this.$el.removeClass("active");
        return this.$el.children(".answers").slideUp();
      };

      QuestionItem.prototype.expand = function() {
        this.active = true;
        this.$el.addClass("active");
        return this.$el.children(".answers").slideDown();
      };

      QuestionItem.prototype.render = function() {
        this.$el.html(this.questionTmpl({
          question: this.model,
          active: this.active
        }));
        return this;
      };

      return QuestionItem;

    })(Backbone.View);
    return QuestionList = (function(_super) {

      __extends(QuestionList, _super);

      function QuestionList() {
        this.update = __bind(this.update, this);

        this.render = __bind(this.render, this);

        this.addAll = __bind(this.addAll, this);

        this.add = __bind(this.add, this);

        this.toggleQuestion = __bind(this.toggleQuestion, this);

        this.initialize = __bind(this.initialize, this);
        return QuestionList.__super__.constructor.apply(this, arguments);
      }

      QuestionList.prototype.tagName = "ul";

      QuestionList.prototype.attributes = {
        id: "questions",
        "class": "questions slicklist"
      };

      QuestionList.prototype.events = {
        "click .question": "toggleQuestion"
      };

      QuestionList.prototype.initialize = function() {
        this.collection = new QuestionCollection();
        this.collection.on("add", this.add);
        this.collection.on("reset", this.addAll);
        this.selectedQuestion = void 0;
        return this.childViews = {};
      };

      QuestionList.prototype.toggleQuestion = function(event) {
        var targetId;
        targetId = event.currentTarget.id;
        if (this.selectedQuestion) {
          this.childViews[this.selectedQuestion].collapse();
        }
        if (targetId === this.selectedQuestion) {
          return this.selectedQuestion = void 0;
        } else {
          this.childViews[targetId].expand();
          return this.selectedQuestion = targetId;
        }
      };

      QuestionList.prototype.add = function(model) {
        var view;
        view = new QuestionItem({
          model: model
        });
        this.childViews[model.id] = view;
        return this.$el.append(view.render().el);
      };

      QuestionList.prototype.addAll = function() {
        return this.collection.each(this.add);
      };

      QuestionList.prototype.render = function() {
        return $("#content").html(this.el);
      };

      QuestionList.prototype.update = function() {
        return this.collection.fetch({
          add: true
        });
      };

      return QuestionList;

    })(Backbone.View);
  });

}).call(this);
